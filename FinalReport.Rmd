---
title: Investigation of Policy and Legislative Actions for the Reduction of Fatal
  Traffic Incidents in Relation to Alcohol and Socio-Economic Factors
author: "Keith Mitchell, ..."
date: "2/12/2021"
output: html_document
---
```{r loadLibs,echo=FALSE,warning=FALSE,message=FALSE}
library(AER)
library(tidyverse)
library(lubridate)
library(lmerTest)
library(scales)
library(kableExtra)
library(ggpubr)
```
```{r loadData, echo=FALSE}
data('Fatalities')
```
```{r briefView, echo=FALSE}
summary(Fatalities[, c('year', 'state', 'pop', 'fatal', 'income', 'unemp', 'miles', 'beertax', 'youngdrivers',  'jail', 'breath', 'service')])
Fatalities[which(is.na(Fatalities$jail) | is.na(Fatalities$service)), c('state','year', 'jail', 'service')]
```
Notice California has missing values in `jail` and `service` only in year 1988.
We create a new variable "frate" which is the the number of fatalities per 10000 residents. 

```{r addVar, echo = FALSE}
Fatalities$frate = Fatalities$fatal/Fatalities$pop * 10000
```

```{r jail_vs_covariate, echo=FALSE, warning=FALSE}

# explore  relationships between jail and unemployment
p1 = ggplot(data=Fatalities, aes(unemp, fill = jail)) + 
          geom_density( alpha = 0.5 ) + 
          labs(title = "jail vs unemployment")
# explore relationships between jail and income
p2 = ggplot(data=Fatalities, aes(income, fill = jail)) + 
          geom_density( alpha = 0.5 )+ 
  labs(title = "jail vs income")


# explore relationships between jail and miles
p3 = ggplot(data=Fatalities, aes(miles, fill = jail)) + 
          geom_density( alpha = 0.5 )+
  labs(title = "jail vs miles")

# explore relationships between jail and beertax
p4 =ggplot(data=Fatalities, aes(beertax, fill = jail)) + 
          geom_density( alpha = 0.5 ) + 
  labs(title = "jail vs beertax")
# explore relationships between jail and youngdrivers
p5 =ggplot(data=Fatalities, aes(youngdrivers, fill = jail)) + 
          geom_density( alpha = 0.5 ) +
   labs(title = "jail vs youngdrivers")


ggarrange(p1, p2, p3, p4, p5, labels = LETTERS[1:5],
          common.legend = TRUE, legend = "bottom")

```

- unemployment does not seem to strongly impact the propensity of being assigned to treatment (jail = yes) or control (jail = no) group.

- It seems that income impacts the propensity of being assigned to treatment (jail = yes) or control (jail = no) group. Therefore income should be included in the selection model.

- mileage driven per person does not seem to strongly impact the propensity of being assigned to treatment (jail = yes) or control (jail = no) group.

- beertax does not seem to strongly impact the propensity of being assigned to treatment (jail = yes) or control (jail = no) group.

- percent of young drivers does not seem to strongly impact the propensity of being assigned to treatment (jail = yes) or control (jail = no) group.

```{r coolFun, echo=FALSE, warning=FALSE}
# Adpated from http://www.sthda.com/english/wiki/scatter-plot-matrices-r-base-graphs
my_cols <- c("#00AFBB", "#FC4E07")  

# Correlation panel
panel.cor <- function(x, y){
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- cor(x, y)
    txt <- paste0("r = ", round(r, digits = 2))
    text(0.5, 0.5, txt, cex = 3*abs(r) )
}

# Customize upper panel
upper.panel<-function(x, y){
  points(x,y, pch = 19, col = alpha( my_cols[Fatalities$jail], 0.3 ) )
}

```

```{r echo=FALSE, warning=FALSE}
pairs( Fatalities[, c('frate', 'income', 'unemp', 'miles', 'beertax', 'youngdrivers') ],
       upper.panel = upper.panel,
       lower.panel = panel.cor )
```


Independent variables chosen based on the degree of correlation with "frate", and we start by building a tentative outcome model without the use of propensity scores.

## Model 1 (treatment (jail = yes) and control (jail = no))

```{r passModel1, echo=FALSE, warning=FALSE}

summary( lmer(frate ~ jail + rescale(unemp) + rescale(income) + rescale(beertax) + rescale(youngdrivers) +  rescale(miles) + (1|state), data=Fatalities) )$coef %>% round(.,3) %>%  kable() %>% kable_styling()

```

We found a non-significant treatment effect, as the factor level jailyes is not statistically significant at p = 0.05. However, the covariates `unemp` and `youngdrivers` are statistically significant at p < 0.001.

Based on our exploratory data analysis and group discussion, we assume that the variables `unemp`, `income`, `beertax`, `youngdrivers` and `miles` have an influence on the assignment to either the control (jail = no) or the treatment (jail = yes) group.

Next we performed a balance analysis, trying to assess the degree of bias during assignment to treatment and control groups, before the use of propensity scores.


```{r preBalance1, echo = FALSE, warning=FALSE, results='asis'}
# balance analysis before estimating propensity scores
cat("jail vs. miles\n")

summary( lm(miles ~ jail, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. income\n")
summary( lm(income ~ jail, data = Fatalities) ) $coefficients %>% round(., 5)%>% kable() %>% kable_styling()

cat("jail vs. beertax\n")
summary( lm(beertax ~ jail, data = Fatalities) )$coefficients %>% round(., 5)%>% kable() %>% kable_styling()

cat("jail vs. youngdrivers\n")
summary( lm(youngdrivers ~ jail, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. unemployment")
summary( lm(unemp ~ jail, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
```
This time it turns out that covariate `unemp` shows strong imbalance between treatment (jail = yes) and control (jail = no ) groups (p < 0.01), and covariate `income` shows a marginal significant imbalance (p < 0.05). Although not significant, the significance levels of covariates `miles` and `beertax` are close to p = 0.05 level, also suggesting potential selection bias. These should be addressed using propensity scores.

```{r selMod1, echo=FALSE, warning=FALSE}
mod1 = glm(jail ~ unemp + income + beertax + youngdrivers + miles,
           family="binomial", data=Fatalities)
summary(mod1)$coef %>% round(., 5) %>% kable() %>% kable_styling()
```
As expected from descriptive analysis, we found that covariate `income` significantly impact the assignment to treatment or control group at p < 0.05. Note that the significance level of `unemp` does not reach p = 0.1, probably due to its strong negative correlation with `income` (r = -0.55) and therefore does not contribute more information when `income` is included in the model. We decide to keep all 5 variables in the selection model regardless of their significance level, as advocated by Caliendo and Kopeinig (2008).

```{r outcomeMod1, echo=FALSE, warning=FALSE}
prob1 = mod1$fitted.values
pscore1 = ifelse( Fatalities$jail == "yes", prob1,(1-prob1) )
weight1 = 1/pscore1

mod1_new = lmer(frate ~ jail + rescale(unemp) + rescale(income) + rescale(beertax) + rescale(youngdrivers) + rescale(miles) + (1|state), data=Fatalities, weights=weight1)

summary(mod1_new)$coef %>% round(., 5) %>% kable() %>% kable_styling()
```
We used logistic regression to determine the probability of treatment/control assignment, given the 5 chose covariates mentioned earlier. The estimated probablities were then converted to propensity scores, whose inverse are included as weights in the linear mixed model.
After applying propensity score weighting, we still do not found significant treatment effect, as the factor level jailyes is not statistically significant at p = 0.05. Again, the covariates `unemp` and `youngdrivers` are statistically significant at p < 0.001.

```{r postBal1, echo=FALSE, warning=FALSE, results='asis'}
# balance analysis after propensity score estimation
cat("jail vs. miles\n")
summary( lm(miles ~ jail, weight = weight1, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. income\n")
summary( lm(income ~ jail, weight = weight1,data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. beertax\n")
summary( lm(beertax ~ jail, weight = weight1,data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. youngdrivers\n")
summary( lm(youngdrivers ~ jail, weight = weight1, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. unemployment\n")
summary( lm(unemp ~ jail, weight = weight1, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
```

The selection biases by `income` and `unemp` are reduced much after propensity score weighting.

```{r passModel2, echo = FALSE,warning=FALSE}

summary( lmer(frate ~ breath + rescale(unemp) + rescale(income) + rescale(beertax) + rescale(youngdrivers) +  rescale(miles) + (1|state), data=Fatalities) )$coef %>% round(.,3) %>%  kable() %>% kable_styling()

```

We found a marginally treatment effect, as the factor level breathyes is statistically significant at p = 0.05. Interestingly, the covariates `unemp` and `youngdrivers` are statistically significant at p < 0.001.

Likewise, we performed a balance analysis before the use of propensity scores.


```{r preBal2, echo = FALSE,warning=FALSE, results='asis'}
# balance analysis before estimating propensity scores
cat("jail vs. miles\n")
summary( lm(miles ~ breath, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. income\n")
summary( lm(income ~ breath, data = Fatalities) ) $coefficients %>% round(., 5)%>% kable() %>% kable_styling()

cat("jail vs. beertax\n")
summary( lm(beertax ~ breath, data = Fatalities) )$coefficients %>% round(., 5)%>% kable() %>% kable_styling()

cat("jail vs. youngdrivers\n")
summary( lm(youngdrivers ~ breath, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. unemployment")
summary( lm(unemp ~ breath, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
```

This time it turns out that covariate `unemp` shows strong imbalance between treatment (jail = yes) and control (jail = no ) groups (p < 0.01), and covariate `income` shows a marginal significant imbalance (p < 0.05). Although not significant, the significance levels of covariates `miles` and `beertax` are close to p = 0.05 level, also suggesting potential selection bias. These should be addressed using propensity scores.

```{r selModel2, echo = FALSE,warning=FALSE}
mod2 = glm(breath ~ unemp + income + beertax + youngdrivers + miles,
           family="binomial", data=Fatalities)
summary(mod2)$coef %>% round(., 5) %>% kable() %>% kable_styling()
```
 We found that covariate `unemp` significantly impact the assignment to treatment or control group at p < 0.001, and covariate `miles` significantly impact the assignment to treatment or control group at p < 0.01. Again, all 5 variables are included in the selection model regardless of their significance level.
 
```{r outcomeModel2, echo = FALSE,warning=FALSE}
prob2 = mod2$fitted.values
pscore2 = ifelse(Fatalities$breath == "yes", prob2,(1-prob2))
weight2 = 1/pscore2
mod2_new = lmer( frate ~ breath+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles)+(1|state),data=Fatalities, weights=weight2)
summary(mod2_new)$coef %>% round(., 5) %>% kable() %>% kable_styling()
```
Likewise, after applying propensity score weighting, we still do not found significant treatment effect, as the factor level breathyes is not statistically significant at p = 0.05. Nevertheless, it is significant at p < 0.1, indicating potential effects that needs further investigation. Again, the covariates unemp and youngdrivers are statistically significant at p < 0.001.

```{r postBal2, echo = FALSE,warning=FALSE, results='asis'}
# balance analysis after propensity score estimation
cat("jail vs. miles\n")
summary( lm(miles ~ breath, weight = weight2, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. income\n")
summary( lm(income ~ breath, weight = weight2,data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. beertax\n")
summary( lm(beertax ~ breath, weight = weight2,data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. youngdrivers\n")
summary( lm(youngdrivers ~ breath, weight = weight2, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. unemployment")
summary( lm(unemp ~ breath, weight = weight2, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
```
Note that the selection biases by `income` and `unemp` are not are reduced much after propensity score weighting, so there still exists substantial selection biases that may invalidate causal inferences.

## Model 3 (control: service)

```{r selModel3, echo = FALSE,warning=FALSE }
mod3 = glm(service ~ rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles),
           family="binomial", data=Fatalities)
prob3 = mod3$fitted.values
pscore3 = ifelse(Fatalities$service == "yes", prob3,(1-prob3))
weight3 = 1/pscore3
mod3_new = lmer(frate~service+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+
                  rescale(miles)+(1|state),data=Fatalities, weights=weight3)
summary(mod3_new)$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
```

Using the same method, we do not found significant treatment effect, as the factor level serviceyes is not statistically significant at p = 0.05 Again, the covariates `unemp` and `youngdrivers` are statistically significant at p < 0.001.

```{r balance3, echo = FALSE,warning=FALSE, results='asis' }
# balance analysis before propensity score estimation
summary( lm(miles ~ service, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
summary( lm(income ~ service,data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
summary( lm(beertax ~ service, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
summary( lm(youngdrivers ~ service, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
summary( lm(unemp ~ service, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

# balance analysis after propensity score estimation
cat("jail vs. miles\n")
summary( lm(miles ~ service, weight = weight3, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. income\n")
summary( lm(income ~ service, weight = weight3,data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. beertax\n")
summary( lm(beertax ~ service, weight = weight3,data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. youngdrivers\n")
summary( lm(youngdrivers ~ service, weight = weight3, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()

cat("jail vs. unemployment")
summary( lm(unemp ~ service, weight = weight3, data = Fatalities) )$coefficients %>% round(., 5) %>% kable() %>% kable_styling()
```

It seems that the selection biases by `beertax` are effectively removed after propensity score weighting.
