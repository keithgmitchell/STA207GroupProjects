---
title: "Project 2"
author: "Seyoung Jung"
date: "2/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r,warning=FALSE,message=FALSE}
library(AER)
library(tidyverse)
library(lubridate)
library(dplyr)
library(lmerTest)
library(scales)
```


```{r}
data('Fatalities')
```


```{r}
summary(Fatalities)
```

Observe the row(s) containing NA value in "jail" and/or "service".
One row (row #28) has NA in the two variables.
```{r}
Fatalities[which(is.na(Fatalities$jail) | is.na(Fatalities$service)), ]
```


Observe the row which has the maximum value from the "miles" variable
Notice the stark difference between the highest and the second highest average miles per driver 
```{r}
Fatalities[order(-Fatalities$miles), ] %>% head(5)

plot(Fatalities$miles[-171], Fatalities$fatal[-171], xlab = 'Average miles per driver', ylab = 'The number of fatalities' )

plot(Fatalities$miles[-171], Fatalities$frate[-171], xlab = 'Average miles per driver', ylab = 'Fatality rate' )
```


Check whether the other rows of California have data on "jail" and "service".
The other rows have "no"s in the jail and service columns. 
```{r}
Fatalities[which(Fatalities$state=="ca"), ]
```


Convert the "state", "year", "drinkage" into a factor variable
```{r}
Fatalities$drinkage = round(Fatalities$drinkage)
Fatalities$drinkage = as.factor(Fatalities$drinkage)
```


Correlation between "fatal" and the other non-categorical variables
```{r}
cor(Fatalities$fatal, Fatalities[, -which(sapply(Fatalities, class)=="factor")])
```


Create a new variable "frate" which is the total number of fatalities over the population of the state. 
Correlation between "frate" and the other non-categorical variables
Some variables (e.g. income, beertax, baptist, miles, and youngdrivers) have relatively high correlations with "frate".
```{r}
Fatalities$frate = Fatalities$fatal/Fatalities$pop

cor(Fatalities$frate, Fatalities[, -which(sapply(Fatalities, class)=="factor")])
```








```{r}
#summary(glm(breath~frate,data=Fatalities,family=binomial))$coefficients # breath vs. frate
#summary(glm(jail~frate,data=Fatalities,family=binomial))$coefficients # jail vs. frate
#summary(glm(service~frate,data=Fatalities,family=binomial))$coefficients # service vs. frate

#summary(glm(breath~unemp,data=Fatalities,family=binomial))$coefficients # breath vs. unemp
#summary(glm(jail~unemp,data=Fatalities,family=binomial))$coefficients # jail vs. unemp
#summary(glm(service~unemp,data=Fatalities,family=binomial))$coefficients # service vs. unemp

#summary(glm(breath~miles,data=Fatalities,family=binomial))$coefficients # breath vs. miles
#summary(glm(jail~miles,data=Fatalities,family=binomial))$coefficients # jail vs. miles
#summary(glm(service~miles,data=Fatalities,family=binomial))$coefficients # service vs. miles

#summary(glm(breath~youngdrivers,data=Fatalities,family=binomial))$coefficients # breath vs. youngdrivers
#summary(glm(jail~youngdrivers,data=Fatalities,family=binomial))$coefficients # jail vs. youngdrivers
#summary(glm(service~youngdrivers,data=Fatalities,family=binomial))$coefficients # service vs. youngdrivers

#summary(glm(breath~beertax,data=Fatalities,family=binomial))$coefficients # breath vs. beertax
#summary(glm(jail~beertax,data=Fatalities,family=binomial))$coefficients # jail vs. beertax
#summary(glm(service~beertax,data=Fatalities,family=binomial))$coefficients # service vs. beertax

#summary(glm(breath~income,data=Fatalities,family=binomial))$coefficients # breath vs. income
#summary(glm(jail~income,data=Fatalities,family=binomial))$coefficients # jail vs. income
#summary(glm(service~income,data=Fatalities,family=binomial))$coefficients # service vs. income
```






==========================================================================================
                              Model Building (Seyoung Jung)
==========================================================================================

```{r}
cor(Fatalities$frate, Fatalities[, -which(sapply(Fatalities, class)=="factor")])
```
Independent variables chosen based on the degree of correlation with "frate"






Model 1 (treatment (jail = yes) and control (jail = no))

```{r}
mod1 = glm(jail ~ rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles),
           family="binomial", data=Fatalities)
summary(mod1)

prob1 = mod1$fitted.values
pscore1 = ifelse(Fatalities$jail == "yes", prob1,(1-prob1))
weight1 = 1/pscore1

mod1_new = lmer(frate~jail+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+
                  rescale(miles)+(1|year),data=Fatalities, weights=weight1)

summary(mod1_new)
```
Goal is to check if "jail" causes the reduction or increase of fatalities. We need to remove/reduce the selection bias by using propensity scores as weights. First, build a selection model to estimate the propensity scores (conditional probability given background variables) by setting "jail" as the target variable, and use the propensity scores to get the weight. Include the weight as an argument in the new model. 










Model 2 (control: breath)
```{r}
mod2 = glm(breath ~ rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles), family="binomial", data=Fatalities)
prob2 = mod2$fitted.values
pscore2 = ifelse(Fatalities$breath == "yes", prob2,(1-prob2))
weight2 = 1/pscore2
mod2_new = lmer(frate~breath+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles)+(1|state),data=Fatalities, weights=weight2)
summary(mod2_new)
```






Model 3 (control: service)
```{r}
mod3 = glm(service ~ rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles),
           family="binomial", data=Fatalities)
prob3 = mod3$fitted.values
pscore3 = ifelse(Fatalities$service == "yes", prob3,(1-prob3))
weight3 = 1/pscore3
mod3_new = lmer(frate~service+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+
                  rescale(miles)+(1|year),data=Fatalities, weights=weight3)
summary(mod3_new)
```




Model 4 (control: service) including jail in model
```{r}
mod4 = glm(service ~ jail+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles), family="binomial", data=Fatalities)
prob4 = mod4$fitted.values
pscore4 = ifelse(Fatalities$service == "yes", prob4,(1-prob4))
weight4 = 1/pscore4
mod4_new = lmer(frate~service+jail+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+rescale(miles)+(1|year),data=Fatalities, weights=weight4)
summary(mod4_new)
```



Model 5 (control: jail) including service in model
```{r}
mod5 = glm(jail ~ service+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+
             rescale(miles), family="binomial", data=Fatalities)
prob5 = mod5$fitted.values
pscore5 = ifelse(Fatalities$service == "yes", prob5,(1-prob5))
weight5 = 1/pscore5
mod5_new = lmer(frate~service+jail+rescale(unemp)+rescale(income)+rescale(beertax)+rescale(youngdrivers)+
                  rescale(miles)+(1|year),data=Fatalities, weights=weight5)
summary(mod5_new)
```

































==========================================================================================
                    Code used by TA in the discussion session
==========================================================================================


```{r}
dat = Fatalities[, c('fatal', 'beertax', 'jail', 'unemp', 'state', 'youngdrivers')]
dat = dat[!is.na(dat$jail), ]

model1 = lmer(fatal~beertax+jail+unemp+youngdrivers+(1|state),data=dat)
summary(model1)
```
Can we say that jail cannot cause the reduction or increase of fatalities?
We cannot get causal effect from an observational study directly because there exists selection bias

Balance analysis
```{r}
model2 = lm(unemp~jail, data=dat)
summary(model2)
```

To remove the selection bias, we can use propensity scores as weights in our model
First, we need to build a selection model for estimating the propensity scores
The propensity score is defined as the conditional probability given background variables
```{r}
Fatalities$service = relevel(Fatalities$service, ref="no")
models = glm(service ~ beertax+unemp+youngdrivers, family="binomial", data=Fatalities)
prob = models$fitted.values
pscore = ifelse(Fatalities$service == "yes", prob,(1-prob))
weight = 1/pscore

model_new = lmer(frate~beertax+service+unemp+youngdrivers+(1|state),data=Fatalities, weights=weight)
summary(model_new)
anova(model_new)
```




